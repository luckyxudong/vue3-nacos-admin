---
name: 完善登出清理逻辑
overview: 分析当前登出逻辑，完善登出时需要清理的缓存和状态，确保用户登出后所有相关数据被正确清理
todos:
  - id: analyze-http-canceler
    content: 分析 HTTP 客户端的 RequestCanceler 访问方式，确定如何在登出时取消所有请求
    status: pending
  - id: add-reset-methods
    content: 在 menu store 和 tabs store 中添加 reset() 方法，用于重置状态
    status: pending
  - id: enhance-logout
    content: 完善 auth store 的 logout 方法，添加完整的清理逻辑
    status: pending
  - id: test-logout
    content: 测试登出功能，确保所有状态和缓存被正确清理
    status: pending
isProject: false
---

# 完善登出清理逻辑计划

## 当前登出逻辑分析

根据 `src/components/layout/Header.vue` 和 `src/stores/modules/auth.ts` 的分析，当前登出逻辑仅做了以下操作：

```typescript:57:62:src/stores/modules/auth.ts
const logout = () => {
  isAuthenticated.value = false
  user.value = null
  token.value = ''
  router.push('/login')
}
```

## 需要清理的内容

### 1. Pinia Store 状态清理

#### 1.1 Auth Store（已部分清理）

- ✅ `isAuthenticated` - 已清理
- ✅ `user` - 已清理  
- ✅ `token` - 已清理
- ⚠️ **问题**：由于使用了 `persist: true`，这些数据会持久化到 localStorage，需要手动清除持久化数据

#### 1.2 Menu Store（需要清理）

- `expandedMenus` - 菜单展开状态（用户偏好，建议重置为默认值）
- `isCollapsed` - 侧边栏折叠状态（用户偏好，建议重置为默认值）

#### 1.3 Tabs Store（需要清理）

- `tabs` - 打开的标签页列表（应重置为仅包含首页）
- `activeTab` - 当前激活的标签页（应重置为首页）

### 2. localStorage 缓存清理

#### 2.1 Pinia 持久化数据

- `auth` - auth store 的持久化数据
- `menu` - menu store 的持久化数据（expandedMenus, isCollapsed）
- `tabs` - tabs store 的持久化数据（tabs, activeTab）

#### 2.2 其他可能的缓存

- `locale` - 语言设置（**保留**，这是用户偏好，不应清除）

### 3. HTTP 请求清理

#### 3.1 取消进行中的请求

- 调用 `RequestCanceler.clear()` 取消所有进行中的 HTTP 请求
- 需要访问 HTTP 客户端的 RequestCanceler 实例

### 4. 路由相关清理

#### 4.1 重置 Tabs

- 在登出时重置 tabs store，确保下次登录时标签页状态干净

## 实现方案

### 方案 1：在 Auth Store 中统一处理（推荐）

在 `src/stores/modules/auth.ts` 的 `logout` 方法中：

1. **清理其他 Store 状态**
   - 重置 menu store 的 `expandedMenus` 和 `isCollapsed` 为默认值
   - 重置 tabs store 的 `tabs` 和 `activeTab` 为默认值
2. **清理 localStorage**
   - 清除 Pinia 持久化的 store 数据（`auth`, `menu`, `tabs`）
   - 保留 `locale`（语言设置）
3. **取消 HTTP 请求**
   - 调用 HTTP 客户端的请求取消器清除所有进行中的请求
4. **路由跳转**
   - 跳转到登录页

### 方案 2：创建统一的清理工具函数

创建一个 `src/utils/logout.ts` 工具文件，集中管理所有清理逻辑，然后在 auth store 中调用。

## 推荐实现细节

### 修改 `src/stores/modules/auth.ts`

```typescript
import { useMenuStore } from './menu'
import { useTabsStore } from './tabs'
import { api } from '@/http'

const logout = () => {
  // 1. 取消所有进行中的 HTTP 请求
  // 需要访问 api 实例的 RequestCanceler
  
  // 2. 清理其他 Store 状态
  const menuStore = useMenuStore()
  const tabsStore = useTabsStore()
  
  // 重置 menu store
  menuStore.expandedMenus = ['/overview']
  menuStore.isCollapsed = false
  
  // 重置 tabs store
  tabsStore.tabs = [{
    title: 'layout.home',
    path: '/',
    closable: false,
  }]
  tabsStore.activeTab = '/'
  
  // 3. 清理 auth store 状态
  isAuthenticated.value = false
  user.value = null
  token.value = ''
  
  // 4. 清理 localStorage 中的 Pinia 持久化数据
  localStorage.removeItem('auth')
  localStorage.removeItem('menu')
  localStorage.removeItem('tabs')
  // 注意：不删除 'locale'，保留用户语言偏好
  
  // 5. 路由跳转
  router.push('/login')
}
```

### 需要解决的问题

1. **HTTP 请求取消器访问**
   - 需要确认如何访问 `api` 实例的 `RequestCanceler`
   - 可能需要导出 `RequestCanceler` 实例或提供清理方法
2. **Store 重置方法**
   - 考虑在 menu store 和 tabs store 中添加 `reset()` 方法，使代码更清晰

## 注意事项

1. **语言设置保留**：`locale` 是用户偏好设置，不应在登出时清除
2. **错误处理**：清理过程中如果出现错误，不应影响登出流程
3. **异步操作**：如果有服务端登出接口，需要先调用接口再清理本地状态
4. **Store 依赖**：确保在清理时正确导入和使用其他 store

## 测试要点

1. 登出后检查 localStorage 中是否还有相关数据
2. 登出后检查各个 store 的状态是否正确重置
3. 登出时进行中的 HTTP 请求是否被正确取消
4. 登出后重新登录，状态是否正常
5. 语言设置是否保留
