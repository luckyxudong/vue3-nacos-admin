---
name: 实现创建配置功能
overview: 在配置列表页面实现创建配置功能，包括弹出框表单、表单验证、代码编辑器集成和提交逻辑。
todos:
  - id: create-textarea
    content: 创建 Textarea 组件（src/components/ui/textarea/Textarea.vue + index.ts）
    status: pending
  - id: create-radiogroup
    content: 创建 RadioGroup 和 RadioGroupItem 组件（src/components/ui/radio-group/）
    status: pending
  - id: add-dialog
    content: 在 list.vue 中添加创建配置的 Dialog 弹出框结构
    status: pending
  - id: implement-form
    content: 实现表单字段（Data ID、Group、标签、归属应用、描述、配置格式、配置内容）
    status: pending
  - id: add-validation
    content: 实现表单验证逻辑（必填、特殊字符验证）
    status: pending
  - id: create-format-validator
    content: 创建配置格式校验工具函数（src/utils/validateContent.ts），支持 JSON/XML/YAML/HTML/Properties 格式校验
    status: pending
  - id: add-check-logic
    content: 实现提交前检查配置是否存在的逻辑
    status: pending
  - id: implement-submit
    content: 实现提交逻辑（调用 createOrUpdate 接口，成功后刷新列表）
    status: pending
  - id: add-styling
    content: 添加样式（代码编辑器样式、表单布局、响应式设计）
    status: pending
isProject: false
---

# 实现创建配置功能

## 概述

在 `src/pages/config/list.vue` 中实现创建配置功能，点击"创建配置"按钮时显示弹出框，包含完整的表单字段和验证逻辑。

## 需要创建的组件

### 1. Textarea 组件

- 位置：`src/components/ui/textarea/Textarea.vue`
- 参考 Input 组件的实现方式
- 支持 v-model、placeholder、disabled 等属性

### 2. RadioGroup 组件

- 位置：`src/components/ui/radio-group/RadioGroup.vue` 和 `RadioGroupItem.vue`
- 用于配置格式选择（TEXT/JSON/XML/YAML/HTML/Properties）
- 支持 v-model 双向绑定

## 主要实现内容

### 1. 在 list.vue 中添加创建配置 Dialog

- 使用现有的 Dialog、DialogContent、DialogHeader、DialogTitle、DialogFooter 组件
- 表单布局参考图片描述和参考实现

### 2. 表单字段实现

- **Data ID**（必填）：Input 组件，验证规则：必填、不能包含特殊字符 `@#\$%\^&\*\s`
- **Group**（必填）：Input 组件，默认值 `DEFAULT_GROUP`，验证规则：必填、最大长度 127、不能包含特殊字符
- **标签**（可选）：Input 组件，支持多个标签用逗号分隔
- **归属应用**（可选）：Select 组件，下拉选择（暂时使用 Input，后续可扩展为带搜索的下拉）
- **描述**（可选）：Textarea 组件，多行输入
- **配置格式**（必填）：RadioGroup 组件，选项：TEXT、JSON、XML、YAML、HTML、Properties，默认 TEXT
- **配置内容**（必填）：Textarea 组件（暂时使用，后续可集成 Monaco Editor），深色主题样式，显示行号

### 3. 表单验证逻辑

- 使用 Vue 3 的响应式数据和计算属性实现验证
- Data ID 和 Group 字段验证特殊字符（参考 `validateChart` 方法）
- 配置内容必填验证
- **配置格式语法验证**：根据选择的配置格式，对配置内容进行格式校验
  - **TEXT**：无需格式校验（纯文本）
  - **JSON**：使用 `JSON.parse()` 验证 JSON 格式，捕获异常并提示错误位置
  - **XML**：使用正则表达式或 DOMParser 验证 XML 格式
  - **YAML**：使用 yaml 解析库（如 `js-yaml`）验证 YAML 格式
  - **HTML**：使用 DOMParser 验证 HTML 格式
  - **Properties**：验证 Properties 格式（key=value 格式，支持多行值）

### 4. 配置格式校验工具函数

- 位置：`src/utils/validateContent.ts`
- 实现 `validateContent.validate({ content, type })` 函数
- 支持的格式类型：`text`、`json`、`xml`、`yaml`、`html`、`properties`
- 返回值：`{ valid: boolean, message?: string }`
- 实现细节：
  - **JSON**：使用 `JSON.parse()` 捕获异常，返回详细的错误信息
  - **XML**：使用浏览器 `DOMParser` API 解析，检查是否有解析错误
  - **YAML**：需要安装 `js-yaml` 库（`pnpm add js-yaml`），使用 `yaml.load()` 验证
  - **HTML**：使用 `DOMParser` 解析 HTML，检查基本结构
  - **Properties**：使用正则表达式验证 `key=value` 格式，支持转义字符和续行

### 5. 提交前检查逻辑

- 参考 `publicConfigBeforeCheck` 方法
- **先进行格式校验**：调用 `validateContent.validate()` 验证配置内容格式
  - 如果格式校验失败，显示错误提示并阻止提交
  - 如果格式校验通过，继续后续检查
- 调用 `configService.getDetail` 检查配置是否存在
- 如果存在，显示错误提示；如果不存在（404），继续提交
- 参考实现中的逻辑：如果格式校验失败但用户确认继续，也可以提交（通过 Dialog.confirm 确认）

### 6. 提交逻辑

- **格式校验**：提交前调用 `validateContent.validate()` 进行格式校验
  - 如果校验失败，显示错误提示（格式：`格式校验失败：${错误信息}`）
  - 如果校验失败但用户选择继续（通过确认对话框），允许提交
- 调用 `configService.createOrUpdate` 接口
- 参数包括：dataId、group、content、appName、desc、config_tags、type、tenant
- 提交成功后关闭弹出框并刷新列表
- 显示成功提示

### 6. 代码编辑器集成（可选，后续扩展）

- 暂时使用 Textarea 组件，样式模拟代码编辑器（等宽字体、深色背景、行号）
- 后续可集成 Monaco Editor 或 CodeMirror

## 文件修改清单

1. **创建组件**：
   - `src/components/ui/textarea/Textarea.vue` + `index.ts`
   - `src/components/ui/radio-group/RadioGroup.vue` + `RadioGroupItem.vue` + `index.ts`
2. **创建工具函数**：
   - `src/utils/validateContent.ts`：配置格式校验工具函数
3. **修改文件**：
   - `src/pages/config/list.vue`：添加 Dialog 弹出框和相关逻辑
4. **安装依赖**（如需要）：
   - `js-yaml`：用于 YAML 格式校验（`pnpm add js-yaml`）

## 关键代码片段

### 表单数据结构

```typescript
const formData = ref({
  dataId: '',
  group: 'DEFAULT_GROUP',
  tags: '',
  appName: '',
  desc: '',
  configType: 'text',
  content: '',
})
```

### 验证函数

```typescript
const validateChart = (value: string): boolean => {
  const chartReg = /[@#\$%\^&\*\s]+/g
  return !chartReg.test(value)
}
```

### 格式校验工具函数

```typescript
// src/utils/validateContent.ts
export interface ValidateResult {
  valid: boolean
  message?: string
}

export const validateContent = {
  validate({ content, type }: { content: string; type: string }): ValidateResult {
    if (!content.trim()) {
      return { valid: false, message: '配置内容不能为空' }
    }

    switch (type.toLowerCase()) {
      case 'text':
        return { valid: true }
      
      case 'json':
        try {
          JSON.parse(content)
          return { valid: true }
        } catch (error) {
          return { valid: false, message: `JSON 格式错误：${error.message}` }
        }
      
      case 'xml':
        try {
          const parser = new DOMParser()
          const doc = parser.parseFromString(content, 'text/xml')
          const errors = doc.querySelectorAll('parsererror')
          if (errors.length > 0) {
            return { valid: false, message: 'XML 格式错误' }
          }
          return { valid: true }
        } catch (error) {
          return { valid: false, message: `XML 解析失败：${error.message}` }
        }
      
      case 'yaml':
        try {
          // 需要安装 js-yaml: pnpm add js-yaml
          const yaml = require('js-yaml')
          yaml.load(content)
          return { valid: true }
        } catch (error) {
          return { valid: false, message: `YAML 格式错误：${error.message}` }
        }
      
      case 'html':
        try {
          const parser = new DOMParser()
          parser.parseFromString(content, 'text/html')
          return { valid: true }
        } catch (error) {
          return { valid: false, message: `HTML 格式错误：${error.message}` }
        }
      
      case 'properties':
        // Properties 格式验证：key=value，支持转义和续行
        const lines = content.split('\n')
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim()
          if (line && !line.startsWith('#') && !line.includes('=')) {
            return { valid: false, message: `Properties 格式错误：第 ${i + 1} 行缺少等号` }
          }
        }
        return { valid: true }
      
      default:
        return { valid: true }
    }
  }
}
```

### 提交前检查（包含格式校验）

```typescript
const publishConfig = async () => {
  // 1. 基础字段验证
  if (!formData.value.dataId || !formData.value.group || !formData.value.content) {
    // 显示错误提示
    return
  }

  // 2. 格式校验
  const formatCheck = validateContent.validate({
    content: formData.value.content,
    type: formData.value.configType,
  })

  if (!formatCheck.valid) {
    // 格式校验失败，询问用户是否继续
    const confirmed = await Dialog.confirm({
      title: '格式校验失败',
      content: `${formatCheck.message}，是否继续提交？`,
    })
    if (!confirmed) {
      return
    }
  }

  // 3. 检查配置是否存在
  try {
    await configService.getDetail({
      dataId: formData.value.dataId,
      group: formData.value.group,
    })
    // 存在，显示错误
    alert('配置已存在')
    return
  } catch (error) {
    // 404 表示不存在，可以创建
  }

  // 4. 提交配置
  try {
    await configService.createOrUpdate({
      dataId: formData.value.dataId,
      group: formData.value.group,
      content: formData.value.content,
      appName: formData.value.appName || undefined,
      desc: formData.value.desc || undefined,
      config_tags: formData.value.tags || undefined,
      type: formData.value.configType,
      tenant: currentTenant.value,
    })
    // 成功提示
    alert('创建成功')
    // 关闭弹出框并刷新列表
    dialogOpen.value = false
    loadConfigList()
  } catch (error) {
    alert('创建失败')
  }
}
```

## 注意事项

1. 使用当前命名空间（`currentTenant.value`）作为 tenant 参数
2. 标签字段需要转换为逗号分隔的字符串
3. 配置格式需要转换为小写（text/json/xml/yaml/html/properties）
4. **格式校验**：
   - 提交前必须先进行格式校验
   - 格式校验失败时，提示用户错误信息，并询问是否继续提交
   - TEXT 格式无需校验（纯文本）
   - JSON/XML/YAML/HTML/Properties 格式需要严格校验
5. 提交成功后需要刷新配置列表
6. Dialog 关闭时需要重置表单数据
7. 表单验证错误需要显示在对应字段下方
8. YAML 格式校验需要安装 `js-yaml` 库（`pnpm add js-yaml`）

## 后续优化

1. 集成 Monaco Editor 作为代码编辑器，提供语法高亮和实时格式校验
2. 增强格式校验功能：
   - JSON 格式校验时显示具体的错误位置（行号、列号）
   - YAML 格式校验时显示详细的错误信息
   - XML 格式校验时显示具体的解析错误
3. 归属应用字段改为带搜索的 Combobox 组件
4. 添加配置内容格式化的快捷键支持（如 JSON 格式化）
5. 支持全屏编辑模式（F11 快捷键）
6. 配置格式切换时，自动格式化内容（如果可能）
